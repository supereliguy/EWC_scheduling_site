<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net 'unsafe-inline' 'wasm-unsafe-eval'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; font-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; connect-src 'self' https://docs.google.com https://sheets.googleapis.com https://cdn.jsdelivr.net https://*.googleusercontent.com; object-src 'none'; base-uri 'self';">
    <title>Ultimate Scheduler (Admin)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=3.1.0">
    <style>
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0d1117; color: #f0f6fc; z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        /* Admin layout overrides */
        .section-content { display: none; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <h4 class="mt-3">Loading Database...</h4>
    </div>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-5 px-4 bg-white py-3 rounded shadow-sm">
            <h1 class="mb-0 text-primary fw-bold">Ultimate Scheduler <span class="text-secondary fs-4 fw-light">| Elijah Wyatt, MD</span></h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" onclick="exportDB()">Export Backup</button>
                <input type="file" id="import-db-input" style="display:none" onchange="importDB(this)">
                <button class="btn btn-outline-secondary" onclick="document.getElementById('import-db-input').click()">Import Backup</button>
                <button class="btn btn-outline-danger" onclick="resetDB()">Reset All</button>
            </div>
        </div>

        <div class="row px-4">
            <!-- Sidebar -->
            <div class="col-md-2 mb-4">
                <div class="list-group shadow-sm">
                    <button class="list-group-item list-group-item-action py-3 fw-bold" onclick="goToSchedule(this)">Schedule</button>
                    <button class="list-group-item list-group-item-action py-3 fw-bold active" onclick="showSection('users-section', this)">Users</button>
                    <button class="list-group-item list-group-item-action py-3 fw-bold" onclick="showSection('sites-section', this)">Sites & Shifts</button>
                    <button class="list-group-item list-group-item-action py-3 fw-bold" onclick="loadGlobalSettings(this)">Global Settings</button>
                    <button class="list-group-item list-group-item-action py-3 fw-bold" onclick="showSection('integrations-section', this)">Integrations</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10">

                <!-- Integrations Section -->
                <div id="integrations-section" class="section-content">
                    <h3>Integrations</h3>
                    <p class="text-muted">Sync schedule requests from external sources.</p>

                    <div class="card mb-4">
                        <div class="card-header bg-light fw-bold">Google Sheets Import</div>
                        <div class="card-body">
                            <p class="small text-secondary">
                                Import requests from a "Published to Web" Google Sheet (CSV format).<br>
                                <strong>Format:</strong> Row 1 = Usernames, Row 2 = Shift Names, Rows 3+ = Data (Date in Col A, TRUE/FALSE in others).
                            </p>
                            <div class="mb-3">
                                <label class="form-label">Google Sheet CSV URL</label>
                                <input type="text" class="form-control" id="gs-csv-url" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Site</label>
                                <select class="form-select" id="gs-target-site" style="max-width: 300px;"></select>
                            </div>
                            <button class="btn btn-success" onclick="syncGoogleSheet()">Sync Now</button>

                            <div id="gs-sync-status" class="mt-3 d-none">
                                <div class="alert alert-secondary">
                                    <h6 class="alert-heading fw-bold" id="gs-status-title">Processing...</h6>
                                    <div id="gs-status-body" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Settings Section -->
                <div id="global-settings-section" class="section-content">
                    <h3>Global Scheduling Defaults</h3>
                    <p class="text-muted small">These settings apply to users who have not set specific preferences.</p>
                    <div class="row g-3" style="max-width: 800px;">
                        <div class="col-md-6"><label class="form-label small fw-bold">Max Consecutive Shifts</label><input type="number" class="form-control" id="gs-max-consecutive"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Min Days Off</label><input type="number" class="form-control" id="gs-min-days-off"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Target Shifts</label><input type="number" class="form-control" id="gs-target-shifts"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Target Variance</label><input type="number" class="form-control" id="gs-variance"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Preferred Block Size</label><input type="number" class="form-control" id="gs-block-size"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Min Consecutive Nights</label><input type="number" class="form-control" id="gs-min-consecutive-nights" value="2"></div>
                        <div class="col-md-6"><label class="form-label small fw-bold">Min Rest Hours (Hard Floor)</label><input type="number" class="form-control" id="gs-min-rest-hours" value="12" step="0.5"></div>
                        <div class="col-12">
                            <div class="form-check form-switch p-3 border rounded bg-light">
                                <input class="form-check-input" type="checkbox" id="gs-enable-fair-distribution" checked>
                                <label class="form-check-label fw-bold" for="gs-enable-fair-distribution">Enable Fair Distribution</label>
                                <div class="form-text small mt-0">If checked, the scheduler will dynamically adjust targets to ensure all users are treated equally relative to available shifts.</div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <h4>Rule Configuration (Weights)</h4>
                    <p class="text-muted small">Configure the importance of each rule. <strong>10 = Hard Rule</strong> (Cannot be broken unless forced). <strong>1-9 = Soft Rule</strong> (Higher number means higher penalty for breaking).</p>

                    <div class="table-responsive" style="max-width: 800px;">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Rule Name</th>
                                    <th>Weight (1-10)</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Availability (Days/Shifts)</td>
                                    <td><input type="number" class="form-control" id="rw-availability" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Respect user's blocked days or specific shift blocks.</small></td>
                                </tr>
                                <tr>
                                    <td>Request Off</td>
                                    <td><input type="number" class="form-control" id="rw-request-off" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Respect user's "Off" requests.</small></td>
                                </tr>
                                <tr>
                                    <td>Request Work (Specific)</td>
                                    <td><input type="number" class="form-control" id="rw-request-work-specific" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Bonus for granting a specific shift request (Green).</small></td>
                                </tr>
                                <tr>
                                    <td>Request Work (Any)</td>
                                    <td><input type="number" class="form-control" id="rw-request-work" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Bonus for granting a general work request.</small></td>
                                </tr>
                                <tr>
                                    <td>Request Avoid Shift</td>
                                    <td><input type="number" class="form-control" id="rw-request-avoid-shift" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Penalty for assigning a shift marked as "Avoid" (Orange).</small></td>
                                </tr>
                                <tr>
                                    <td>Max Consecutive Shifts</td>
                                    <td><input type="number" class="form-control" id="rw-max-consecutive" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Do not exceed the maximum number of consecutive working days.</small></td>
                                </tr>
                                <tr>
                                    <td>Min Days Off</td>
                                    <td><input type="number" class="form-control" id="rw-min-days-off" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Ensure users get the minimum number of days off after a block of shifts.</small></td>
                                </tr>
                                <tr>
                                    <td>Target Shift Variance</td>
                                    <td><input type="number" class="form-control" id="rw-target-variance" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Do not exceed the target number of shifts by more than the allowed variance.</small></td>
                                </tr>
                                <tr>
                                    <td>Min Rest Hours (Hard)</td>
                                    <td><input type="number" class="form-control" id="rw-min-rest-hours" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Enforce minimum hours off between any two shifts.</small></td>
                                </tr>
                                <tr>
                                    <td>Circadian (Strict)</td>
                                    <td><input type="number" class="form-control" id="rw-circadian-strict" min="1" max="10" value="10"></td>
                                    <td><small class="text-muted">Prevent a Day shift immediately following a Night shift (less than 24h rest).</small></td>
                                </tr>
                                <tr>
                                    <td>Circadian (Soft)</td>
                                    <td><input type="number" class="form-control" id="rw-circadian-soft" min="1" max="10" value="5"></td>
                                    <td><small class="text-muted">Prefer more than 1 day off when switching from Night to Day.</small></td>
                                </tr>
                                <tr>
                                    <td>Min Consecutive Nights</td>
                                    <td><input type="number" class="form-control" id="rw-min-consecutive-nights" min="1" max="10" value="5"></td>
                                    <td><small class="text-muted">Avoid single night shifts. Prefer blocks of nights.</small></td>
                                </tr>
                                <tr>
                                    <td>Preferred Block Size</td>
                                    <td><input type="number" class="form-control" id="rw-block-size" min="1" max="10" value="5"></td>
                                    <td><small class="text-muted">Try to group shifts into blocks of the preferred size.</small></td>
                                </tr>
                                <tr>
                                    <td>Weekend Fairness</td>
                                    <td><input type="number" class="form-control" id="rw-weekend-fairness" min="1" max="10" value="5"></td>
                                    <td><small class="text-muted">Distribute weekend shifts evenly among users.</small></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3"><button type="button" class="btn btn-primary" onclick="saveGlobalSettings()"><i class="bi bi-check-circle"></i> Save All Settings</button></div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="section-content" style="display:block;">
                    <h3>Manage Users</h3>
                    <div class="d-flex flex-wrap gap-2 toolbar-container align-items-center">
                        <div class="input-group input-group-sm" style="width: auto; flex-grow: 1; min-width: 300px;">
                            <input type="text" class="form-control form-control-sm" id="new-username" placeholder="Username">
                            <select class="form-select form-select-sm" id="new-role" style="max-width: 140px;" title="System Access Level">
                                <option value="user">User Access</option>
                                <option value="admin">Admin Access</option>
                            </select>
                            <button class="btn btn-primary btn-sm" id="create-user-btn"><i class="bi bi-person-plus"></i> Create</button>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="openBulkModal('users')"><i class="bi bi-people"></i> Bulk Add</button>
                            <button class="btn btn-info btn-sm" onclick="openBulkMetricsModal()"><i class="bi bi-graph-up"></i> Metrics</button>
                        </div>
                    </div>
                    <table class="table table-bordered" id="users-table">
                        <thead><tr><th>ID</th><th>Username</th><th>System Access</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Sites Section -->
                <div id="sites-section" class="section-content">
                    <h3>Sites</h3>
                    <div class="d-flex flex-wrap gap-2 toolbar-container align-items-center">
                        <div class="input-group input-group-sm" style="width: auto; flex-grow: 1; min-width: 300px;">
                            <input type="text" class="form-control form-control-sm" id="new-site-name" placeholder="Site Name">
                            <button class="btn btn-primary btn-sm" id="create-site-btn"><i class="bi bi-plus-lg"></i> Create Site</button>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="openBulkModal('sites')"><i class="bi bi-list-check"></i> Bulk Add</button>
                    </div>
                    <table class="table table-bordered" id="sites-table">
                        <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>

                    <div id="shifts-container" style="display:none; margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
                        <select id="shift-site-select" style="display:none"></select>
                        <h4>Shifts for <span id="current-shift-site-name"></span></h4>
                        <button class="btn btn-sm btn-secondary mb-3" onclick="closeShiftsEditor()">Close Shift Editor</button>

                        <div class="toolbar-container">
                            <h5>Add Shift</h5>
                            <div class="row g-2">
                                <div class="col-md-4"><input type="text" class="form-control form-control-sm" id="new-shift-name" placeholder="Shift Name (e.g. Day)"></div>
                                <div class="col-md-3"><input type="time" class="form-control form-control-sm" id="new-shift-start" value="08:00"></div>
                                <div class="col-md-3"><input type="time" class="form-control form-control-sm" id="new-shift-end" value="16:00"></div>
                                <div class="col-md-2"><input type="number" class="form-control form-control-sm" id="new-shift-staff" placeholder="Qty" value="1"></div>
                                <div class="col-12 mt-2">
                                    <label class="form-label small fw-bold mb-1">Active Days:</label><br>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="0" checked id="sd-0"><label class="form-check-label small" for="sd-0">Sun</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="1" checked id="sd-1"><label class="form-check-label small" for="sd-1">Mon</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="2" checked id="sd-2"><label class="form-check-label small" for="sd-2">Tue</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="3" checked id="sd-3"><label class="form-check-label small" for="sd-3">Wed</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="4" checked id="sd-4"><label class="form-check-label small" for="sd-4">Thu</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="5" checked id="sd-5"><label class="form-check-label small" for="sd-5">Fri</label></div>
                                    <div class="form-check form-check-inline"><input class="form-check-input shift-day-check" type="checkbox" value="6" checked id="sd-6"><label class="form-check-label small" for="sd-6">Sat</label></div>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm mt-2" id="create-shift-btn">Add Shift</button>
                        </div>
                        <table class="table table-bordered" id="shifts-table">
                            <thead><tr><th>Name</th><th>Times</th><th>Staff</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Site Dashboard (New) -->
                <div id="site-dashboard-section" class="section-content">
                    <div class="d-flex justify-content-between">
                        <h2 id="sd-site-name">Site Name</h2>
                        <button class="btn btn-outline-secondary" onclick="showSection('sites-section')">Back to Sites</button>
                    </div>
                    <hr>

                    <!-- Tabs for Site Dashboard -->
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#sd-schedule">Schedule</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sd-users">Users</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sd-categories">Roles</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sd-stats">Stats</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sd-settings">Settings</a></li>
                    </ul>

                    <div class="tab-content">
                        <!-- Schedule Editor -->
                        <div class="tab-pane fade show active" id="sd-schedule">
                            <!-- New Controls -->
                            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 toolbar-container">
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-secondary" onclick="changeMonth(-1)" title="Previous Month"><i class="bi bi-chevron-left"></i></button>
                                    <input type="month" id="schedule-month-picker" class="form-control form-control-sm" style="width: auto;" onchange="onMonthPickerChange()" title="Select Month">
                                    <button class="btn btn-sm btn-secondary" onclick="changeMonth(1)" title="Next Month"><i class="bi bi-chevron-right"></i></button>
                                </div>

                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-primary active" id="view-dates-shifts-btn" onclick="switchScheduleView('dates-shifts')" title="By Date"><i class="bi bi-list-ul"></i> Dates</button>
                                        <button type="button" class="btn btn-outline-primary" id="view-simple-btn" onclick="switchScheduleView('simple')" title="Simple Table"><i class="bi bi-table"></i> Table</button>
                                        <button type="button" class="btn btn-outline-primary" id="view-calendar-btn" onclick="switchScheduleView('calendar')" title="Calendar"><i class="bi bi-calendar3"></i> Cal</button>
                                        <button type="button" class="btn btn-outline-primary" id="view-shifts-dates-btn" onclick="switchScheduleView('shifts-dates')" title="By Shift"><i class="bi bi-arrow-left-right"></i> Shifts</button>
                                        <button type="button" class="btn btn-outline-primary" id="view-timeline-btn" onclick="switchScheduleView('timeline')" title="Timeline"><i class="bi bi-bar-chart-steps"></i> Time</button>
                                    </div>
                                    <div class="vr mx-2 text-secondary d-none d-md-block"></div>
                                    <div class="input-group input-group-sm" style="width: 100px;" title="Iterations">
                                        <span class="input-group-text bg-dark text-white border-secondary">N</span>
                                        <input type="number" class="form-control bg-dark text-white border-secondary" id="schedule-iterations" value="100" min="1" step="10">
                                    </div>
                                    <button class="btn btn-sm btn-warning fw-bold text-dark" id="generate-schedule-btn" title="Run Auto-Scheduler"><i class="bi bi-magic"></i> Auto</button>
                                    <button class="btn btn-sm btn-secondary" onclick="openSnapshotsModal()" title="History"><i class="bi bi-clock-history"></i></button>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-gear"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><button class="dropdown-item" onclick="exportScheduleCSV()"><i class="bi bi-filetype-csv me-2"></i>Export CSV</button></li>
                                            <li><button class="dropdown-item" onclick="exportSchedulePDF()"><i class="bi bi-file-pdf me-2"></i>Export PDF</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button class="dropdown-item" onclick="lockAllAssignments(true)"><i class="bi bi-lock me-2"></i>Lock All</button></li>
                                            <li><button class="dropdown-item" onclick="lockAllAssignments(false)"><i class="bi bi-unlock me-2"></i>Unlock All</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button class="dropdown-item text-danger" onclick="clearSchedule()"><i class="bi bi-trash me-2"></i>Clear Month</button></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden inputs for backward compatibility with existing logic -->
                            <input type="hidden" id="schedule-start-date">
                            <input type="hidden" id="schedule-days">

                            <div id="generation-status" class="d-none ms-2 align-items-center mt-2" style="width: 300px;">
                                <span class="fw-bold text-info me-2 small">Generating...</span>
                                <div class="progress flex-grow-1" style="height: 10px;">
                                    <div id="generation-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div id="schedule-health-panel" class="mb-3"></div>

                            <div id="schedule-display" style="min-height: 500px;"></div>
                        </div>

                        <!-- Site Users -->
                        <div class="tab-pane fade" id="sd-users">
                            <h4>Site Users</h4>
                            <div id="site-users-list"></div>
                        </div>

                        <!-- Roles (Categories) -->
                        <div class="tab-pane fade" id="sd-categories">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Staff Roles</h4>
                                <button class="btn btn-primary btn-sm" onclick="openCategoryModal()">Add Role</button>
                            </div>
                            <p class="text-muted small">
                                Define roles for your staff.
                                <strong>Priority:</strong> Lower number = Higher Importance.
                                <strong>Fill First:</strong> Prioritize filling these users' requested shifts before others (Backfill).
                            </p>
                            <table class="table table-bordered" id="categories-table">
                                <thead><tr><th>Priority</th><th>Name</th><th>Color</th><th>Flags</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <!-- Stats -->
                        <div class="tab-pane fade" id="sd-stats">
                            <h4>Fairness & Stats</h4>
                            <div id="site-stats-display"></div>
                        </div>

                        <!-- Settings -->
                        <div class="tab-pane fade" id="sd-settings">
                            <h4>Site Settings</h4>
                            <div class="row g-3" style="max-width: 600px;">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Weekend Definition</label>
                                    <p class="text-muted small mb-2">Define when the weekend starts and ends. Shifts starting within this window are counted as weekend shifts.</p>
                                    <div class="row g-2 toolbar-container">
                                        <div class="col-md-6">
                                            <label class="small fw-bold">Start Day</label>
                                            <select class="form-select form-select-sm" id="site-weekend-start-day">
                                                <option value="0">Sunday</option>
                                                <option value="1">Monday</option>
                                                <option value="2">Tuesday</option>
                                                <option value="3">Wednesday</option>
                                                <option value="4">Thursday</option>
                                                <option value="5">Friday</option>
                                                <option value="6">Saturday</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold">Start Time</label>
                                            <input type="time" class="form-control form-control-sm" id="site-weekend-start-time">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold">End Day</label>
                                            <select class="form-select form-select-sm" id="site-weekend-end-day">
                                                <option value="0">Sunday</option>
                                                <option value="1">Monday</option>
                                                <option value="2">Tuesday</option>
                                                <option value="3">Wednesday</option>
                                                <option value="4">Thursday</option>
                                                <option value="5">Friday</option>
                                                <option value="6">Saturday</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold">End Time</label>
                                            <input type="time" class="form-control form-control-sm" id="site-weekend-end-time">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <button class="btn btn-primary btn-sm" onclick="saveSiteSettings()"><i class="bi bi-check-lg"></i> Save Settings</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <footer class="text-center py-3 mt-4 border-top text-muted small">
            &copy; Elijah Wyatt, MD
        </footer>
    </div>

    <!-- Conflict Modal -->
    <div class="modal fade" id="conflictModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark">Schedule Conflicts Detected</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="lead">The schedule could not be fully generated due to the following constraints:</p>
                    <div id="conflict-report-list" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd;">
                        <!-- conflicts -->
                    </div>
                    <div class="alert alert-info mt-3">
                        <strong>Recommendation:</strong> You can choose to "Force Fill", which will break the lowest priority rules (based on User Categories) to ensure all slots are filled.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="forceGenerateSchedule()">Force Fill (Break Rules)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div class="modal fade" id="changelogModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">What's New</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="changelog-body">
                    <!-- Content injected via JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modals -->
    <!-- Site Users Modal -->
    <div class="modal fade" id="siteUsersModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Manage Site Users</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="site-users-site-id">
                    <div id="site-users-checkbox-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- Checkboxes injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveSiteUsers()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg"> <!-- Larger modal -->
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">User Preferences</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="settings-user-id">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>General</h6>
                            <div class="mb-2"><label>Max Consecutive</label><input type="number" class="form-control" id="setting-max-consecutive"></div>
                            <div class="mb-2"><label>Min Days Off</label><input type="number" class="form-control" id="setting-min-days-off"></div>
                            <div class="mb-2"><label>Target Shifts</label><input type="number" class="form-control" id="setting-target-shifts"></div>
                            <div class="mb-2"><label>Max Variance</label><input type="number" class="form-control" id="setting-variance"></div>
                            <div class="mb-2"><label>Preferred Block Size</label><input type="number" class="form-control" id="setting-block-size"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Shift Preference Order</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="setting-no-preference" onchange="toggleShiftRanking(this.checked)">
                                <label class="form-check-label" for="setting-no-preference">No Preference (Random)</label>
                            </div>
                            <div id="shift-ranking-container" class="list-group" style="max-height: 250px; overflow-y: auto;">
                                <div class="text-center p-3 text-muted">Loading...</div>
                            </div>
                            <small class="text-muted d-block mt-1">Drag and drop items to prioritize.</small>
                        </div>
                    </div>
                    <hr>
                    <h6>Availability Rules (Uncheck to Block)</h6>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Days of Week</strong>
                            <div id="setting-avail-days" class="border p-2 rounded bg-light"></div>
                        </div>
                        <div class="col-md-8">
                            <strong>Shifts (By Site)</strong>
                            <div id="setting-avail-shifts" class="border p-2 rounded bg-light" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <hr>
                    <h6>Requests</h6>
                    <button class="btn btn-outline-primary" onclick="openRequestsModal()">Open Requests Calendar</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Requests Calendar Modal -->
    <div class="modal fade" id="requestsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Requests: <span id="req-modal-username"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select id="req-site-select" class="form-select" onchange="updateReqCalendar()"></select>
                        </div>
                         <div class="col-md-3">
                            <input type="month" id="req-calendar-month" class="form-control" onchange="updateReqCalendar()">
                        </div>
                        <div class="col-md-6 text-end d-flex align-items-center justify-content-end gap-2">
                            <select id="req-shift-select" class="form-select form-select-sm" style="max-width: 150px;" disabled>
                                <option value="">Any Shift</option>
                            </select>
                            <div class="btn-group">
                                <button id="req-work-btn" class="btn btn-outline-success" onclick="setReqMode('work')" title="Mark as preferred to work (Green, High Priority)">Work</button>
                                <button id="req-off-btn" class="btn btn-outline-danger" onclick="setReqMode('off')" title="Mark as unavailable for this shift (Red, Hard Stop)">Off</button>
                                <button id="req-clear-btn" class="btn btn-outline-secondary" onclick="setReqMode('clear')" title="Clear request">Clear</button>
                            </div>
                        </div>
                    </div>
                    <div id="req-calendar-container"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="saveUserRequests()">Save Requests</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Role</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="cat-id">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="cat-name"></div>
                    <div class="mb-3"><label>Priority (Lower number = Higher Importance)</label><input type="number" class="form-control" id="cat-priority" value="10"></div>
                    <div class="mb-3"><label>Color</label><input type="color" class="form-control form-control-color" id="cat-color" value="#ffffff"></div>

                    <hr>
                    <h6>Configuration</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="cat-fill-first">
                        <label class="form-check-label fw-bold" for="cat-fill-first">Fill First / Core Staff</label>
                        <div class="form-text small mt-0">Ensures these users get their requested shifts filled before backfill staff.</div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="cat-is-manual">
                        <label class="form-check-label" for="cat-is-manual">Manual Assignments Only</label>
                        <div class="form-text small mt-0">Skip this role during auto-scheduling.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Snapshot Modal -->
    <div class="modal fade" id="snapshotModal" tabindex="-1">
         <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">History</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="new-snapshot-desc" placeholder="Desc">
                        <button class="btn btn-primary" onclick="createSnapshot()">Save State</button>
                    </div>
                    <table class="table table-sm" id="snapshots-table">
                        <thead><tr><th>Time</th><th>Desc</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Metrics Modal -->
    <div class="modal fade" id="bulkMetricsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Update User Metrics</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">
                        Edit user metrics below. You can copy columns from Excel and paste them into the input fields.<br>
                        <strong>Column Order:</strong> Target Shifts &rarr; Max Variance &rarr; Ideal Block Size &rarr; Max Consecutive &rarr; Min Days Off
                    </p>
                    <div style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-striped" id="bulk-metrics-table">
                            <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th>Username</th>
                                    <th>Target Shifts</th>
                                    <th>Max Variance</th>
                                    <th>Ideal Block Size</th>
                                    <th>Max Consecutive</th>
                                    <th>Min Days Off</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBulkMetrics()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add Modal -->
    <div class="modal fade" id="bulkAddModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulk-modal-title">Bulk Add</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted" id="bulk-modal-desc">Paste items here, one per line.</p>
                    <textarea class="form-control mb-3" id="bulk-input-text" rows="10" placeholder="Paste list here..."></textarea>

                    <div id="bulk-results" class="alert alert-info d-none">
                        <!-- Results will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkAdd()">Process</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-body">
                    <!-- Dynamic Message -->
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- SQL.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- App Scripts -->
    <script src="version.js?v=3.1.0"></script>
    <script type="module" src="calendar-widget.js?v=3.1.0"></script>
    <script src="db-wrapper.js?v=3.1.0"></script>
    <script src="scheduler.js?v=3.1.0"></script>
    <script src="api-router.js?v=3.1.0"></script>

    <!-- UI Logic -->
    <!-- Removed dashboard.js -->
    <script src="admin.js?v=3.1.0"></script>

    <script>
        // Global Bootstrapper
        async function initApp() {
            try {
                await window.db.init();
                document.getElementById('loading').style.display = 'none';

                if(window.loadUsers) window.loadUsers();
                if(window.loadSites) window.loadSites();

            } catch (e) {
                document.getElementById('loading').innerHTML = `<h4 class="text-danger">Error: ${e.message}</h4>`;
                console.error(e);
            }
        }

        // Export/Import
        window.exportDB = async () => {
            const data = window.db.db.export();
            const blob = new Blob([data], {type: 'application/x-sqlite3'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'schedule_backup.sqlite';
            a.click();
        };

        window.importDB = async (input) => {
            if(!input.files.length) return;
            const file = input.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const u8 = new Uint8Array(arrayBuffer);

            try {
                // Validate before loading
                window.db.validateImport(u8);

                // Re-init DB
                // window.SQL is not exposed globally, we access it via the initialized db instance
                window.db.db = new window.db.SQL.Database(u8);
                await window.db.save();
                alert('Database imported successfully! Reloading...');
                location.reload();
            } catch (e) {
                console.error(e);
                alert('Import Failed: ' + e.message);
                // Clear input
                input.value = '';
            }
        };

        window.resetDB = async () => {
             if(confirm('This will wipe all data. Are you sure?')) {
                 // Clear IndexedDB
                 const req = indexedDB.deleteDatabase("ScheduleAppDB");
                 req.onsuccess = () => location.reload();
             }
        };

        // Tab / Section Switching Helper
        window.showSection = (id, btn) => {
            document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';

            if(btn) {
                document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
            }
        };

        window.closeShiftsEditor = () => {
            document.getElementById('shifts-container').style.display = 'none';
        };

        // Expose SQL Class for restore logic if needed
        window.initSqlJs = window.initSqlJs;

        // Start
        initApp();
    </script>
</body>
</html>
